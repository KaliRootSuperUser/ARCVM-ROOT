name: Build Kernel - ChromeOS ARCVM + SukiSU Ultra + SuSFS
on:
  workflow_call:
  workflow_dispatch:

env:
  git_tag: chromeos-5.10-arcvm

jobs:
  build:
    if: github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    strategy:
      matrix:
        include:
          - arch: x86_64
            kernel_image_name: bzImage
            build_config: build.config.gki.x86_64
            defconfig: x86_64_arcvm_defconfig
          - arch: arm64
            kernel_image_name: Image
            build_config: build.config.gki.aarch64
            defconfig: arm64_arcvm_defconfig

    name: Build ChromeOS ARCVM + SukiSU Ultra + SuSFS (${{ matrix.arch }})
    runs-on: ubuntu-22.04  # Fixed the typo here
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel

    steps:
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc \
              bison build-essential ca-certificates flex git gnupg \
              libelf-dev libssl-dev lsb-release software-properties-common wget \
              libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
              rsync python3 device-tree-compiler curl bash

          sudo ln -s --force python3 /usr/bin/python

          export LLVM_VERSION=14
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION all
          rm ./llvm.sh
          for tool in clang ld.lld llvm-objdump llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-readelf clang++; do
            sudo ln -sf /usr/bin/${tool}-$LLVM_VERSION /usr/bin/$tool
          done

      - name: Checkout kernel source
        run: |
          git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b ${{ env.git_tag }} --depth=1 kernel

      - name: Extract kernel version
        working-directory: kernel
        run: |
          VERSION=$(grep -E '^VERSION = ' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep -E '^PATCHLEVEL = ' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep -E '^SUBLEVEL = ' Makefile | awk '{print $3}')
          EXTRAVERSION=$(grep -E '^EXTRAVERSION = ' Makefile | awk '{print $3}')
          echo "ChromeOS ARCVM Linux kernel version: $VERSION.$PATCHLEVEL.$SUBLEVEL$EXTRAVERSION"
          echo "version=$VERSION.$PATCHLEVEL.$SUBLEVEL$EXTRAVERSION" >> $GITHUB_ENV

      - name: Integrate SukiSU Ultra + SuSFS (susfs-main)
        working-directory: kernel
        run: |
          echo "[+] Applying SukiSU Ultra + SuSFS (susfs-main) via official script..."
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          echo "SukiSU Ultra + SuSFS integration completed."

      - name: Add Missing SuSFS Module Files  # ← NEW STEP: Fixes the header error
        working-directory: kernel
        run: |
          echo "[+] Fetching and integrating susfs4ksu module files..."
          
          # Clone the susfs4ksu repo (main branch)
          git clone https://gitlab.com/simonpunk/susfs4ksu.git --depth=1 susfs4ksu-temp
          
          # Copy SuSFS source files to kernel tree
          cp -r susfs4ksu-temp/susfs drivers/
          
          # Clean up temp clone
          rm -rf susfs4ksu-temp
          
          # Add susfs to drivers Makefile (if not already added by script)
          DRIVER_MAKEFILE=drivers/Makefile
          if ! grep -q "susfs" "$DRIVER_MAKEFILE"; then
            echo "obj-\$(CONFIG_SUSFS) += susfs/" >> "$DRIVER_MAKEFILE"
          fi
          
          # Add susfs to drivers Kconfig (if not already added)
          DRIVER_KCONFIG=drivers/Kconfig
          if ! grep -q "susfs" "$DRIVER_KCONFIG"; then
            sed -i "/endmenu/i\\source \"drivers/susfs/Kconfig\"" "$DRIVER_KCONFIG"
          fi
          
          echo "[+] SuSFS module files integrated."

      - name: Enable SuSFS Config in Defconfig  # ← NEW STEP: Ensures SuSFS is built
        working-directory: kernel
        run: |
          echo "[+] Enabling CONFIG_SUSFS in .config..."
          # This will be applied after defconfig in the build step
          echo "CONFIG_SUSFS=m" >> "${{ matrix.defconfig }}"
          echo "[+] SuSFS config enabled."

      - name: Build Kernel
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          set -a && . ${{ matrix.build_config }}; set +a
          export DEFCONFIG=${{ matrix.defconfig }}

          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null

          # Append SuSFS config if not already enabled
          scripts/config --file .config -e SUSFS

          # Ensure ThinLTO is enabled (required by ChromeOS ARCVM)
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e THINLTO -e LTO_CLANG_THIN

          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) ${KERNEL_IMAGE_NAME} modules prepare-objtool

          ls -lh arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}
          echo "file_path=$(pwd)/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV

      - name: Upload kernel-ARCVM-${{ matrix.arch }}-SukiSU-Ultra-${{ env.version }}
        uses: actions/upload-artifact@v5
        with:
          name: kernel-ARCVM-${{ matrix.arch }}-SukiSU-Ultra-susfs-${{ env.version }}
          path: ${{ env.file_path }}