name: Build Kernel SukiSU-Ultra + SUSFS + KernelSU - ChromeOS ARCVM
on:
  workflow_call:
    inputs:
      use_kpm:
        required: false
        type: boolean
        default: true
      use_zram:
        required: false
        type: boolean
        default: true
      custom_version:
        required: false
        type: string
        default: 'ARCVM-KSU-SUSFS-5.10-245'
  workflow_dispatch:
    inputs:
      use_kpm:
        description: 'Enable KPM (SukiSU only)'
        required: false
        type: boolean
        default: true
      use_zram:
        description: 'Enable ZRAM/LZ4KD'
        required: false
        type: boolean
        default: true
      custom_version:
        description: 'Custom kernel version suffix'
        required: false
        type: string
        default: 'ARCVM-KSU-SUSFS-5.10-245'

env:
  git_tag: chromeos-5.10-arcvm

jobs:
  build:
    if: github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    strategy:
      matrix:
        include:
          - arch: x86_64
            kernel_image_name: bzImage
            build_config: build.config.gki.x86_64
            defconfig: x86_64_arcvm_defconfig
          - arch: arm64
            kernel_image_name: Image
            build_config: build.config.gki.aarch64
            defconfig: arm64_arcvm_defconfig

    name: Build ChromeOS ARCVM kernel
    runs-on: ubuntu-22.04
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel

    steps:
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc \
              bison build-essential ca-certificates flex git gnupg \
              libelf-dev libssl-dev lsb-release software-properties-common wget \
              libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
              rsync python3 device-tree-compiler

          sudo ln -s --force python3 /usr/bin/python

          export LLVM_VERSION=14
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION
          rm ./llvm.sh
          sudo ln -s --force /usr/bin/clang-$LLVM_VERSION /usr/bin/clang
          sudo ln -s --force /usr/bin/ld.lld-$LLVM_VERSION /usr/bin/ld.lld
          sudo ln -s --force /usr/bin/llvm-objdump-$LLVM_VERSION /usr/bin/llvm-objdump
          sudo ln -s --force /usr/bin/llvm-ar-$LLVM_VERSION /usr/bin/llvm-ar
          sudo ln -s --force /usr/bin/llvm-nm-$LLVM_VERSION /usr/bin/llvm-nm
          sudo ln -s --force /usr/bin/llvm-strip-$LLVM_VERSION /usr/bin/llvm-strip
          sudo ln -s --force /usr/bin/llvm-objcopy-$LLVM_VERSION /usr/bin/llvm-objcopy
          sudo ln -s --force /usr/bin/llvm-readelf-$LLVM_VERSION /usr/bin/llvm-readelf
          sudo ln -s --force /usr/bin/clang++-$LLVM_VERSION /usr/bin/clang++

      - name: Checkout KernelSU
        uses: actions/checkout@v5
        with:
          path: KernelSU
          fetch-depth: 0

      - name: Clone Dependencies
        run: |
          echo "[+] Cloning required repositories"

          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-android12-5.10 --depth=1

          git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1

          git clone https://github.com/Tools-cx-app/kernel_patches.git --depth=1

      - name: Setup kernel source
        run: git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b ${{ env.git_tag }} --depth=1

      - name: Extract version from Makefile
        working-directory: kernel
        run: |
          VERSION=$(grep -E '^VERSION = ' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep -E '^PATCHLEVEL = ' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep -E '^SUBLEVEL = ' Makefile | awk '{print $3}')
          echo "ChromeOS ARCVM Linux kernel version: $VERSION.$PATCHLEVEL.$SUBLEVEL"
          echo "version=$VERSION.$PATCHLEVEL.$SUBLEVEL" >> $GITHUB_ENV

      - name: Setup KernelSU (SukiSU Ultra)
        working-directory: kernel
        run: |
          echo "[+] Installing SukiSU Ultra"
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main

          echo "[+] KernelSU setup done."
          KSU_VERSION=$(($(git rev-list --count HEAD --before={2022-01-01}) + 22000))
          echo "KernelSU version: $KSU_VERSION"
          echo "kernelsu_version=$KSU_VERSION" >> $GITHUB_ENV

      - name: Fix And Bypass KernelSU KPM issue - drivers/kernelsu/kpm/kpm.c
        working-directory: kernel
        run: |
          FILE="drivers/kernelsu/kpm/kpm.c"
          echo "export KCFLAGS=\"\$KCFLAGS -Wno-error\"" >> ../.kcflags_env.sh
          if ! grep -q 'pragma clang diagnostic ignored "-Wunused-result"' "$FILE"; then
            sed -i '1i #pragma clang diagnostic ignored "-Wunused-result"' "$FILE"
          fi

    

   
      - name: Apply ZRAM/LZ4KD Patches
        if: ${{ inputs.use_zram }}
        working-directory: kernel
        run: |
          echo "[+] Adding ZRAM/LZ4KD support"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel

          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/include/linux/* $KERNEL_ROOT/include/linux/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/lib/* $KERNEL_ROOT/lib/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/crypto/* $KERNEL_ROOT/crypto/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k_oplus $KERNEL_ROOT/lib/

          cd $KERNEL_ROOT
          cp $GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true
          cp $GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4k_oplus.patch ./
          patch -p1 -F 3 < lz4k_oplus.patch || true

      - name: Hide Detection Patches
        working-directory: kernel
        run: |
          echo "[+] Applying hide detection patches"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          cd $KERNEL_ROOT

          cp $GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch || true

      - name: Configure Custom Arch x86_64 KernelSU + SukiSU + SUSFS Kconfig
        working-directory: kernel
        run: |
          echo "[+] Configuring custom Arch x86_64 KernelSU + SukiSU + SUSFS Kconfig"
          KCONFIG_FILE=$GITHUB_WORKSPACE/kernel/arch/x86/Kconfig

          echo '

          # --- KernelSU/SUSFS Configuration ---
          menu "KernelSU and SUSFS Support"

          config KSU
          	bool "KernelSU"
          	default y
          	help
          	  Enable support for KernelSU, a root solution for Android kernels.
          	  This option enables the core functionality of KernelSU.

          if KSU

          config KSU_FS
          	bool "KernelSU Filesystem"
          	default y
          	help
          	  Enable the KernelSU filesystem support.

          config KSU_ALLOWLIST
          	bool "KernelSU Allowlist"
          	default y
          	help
          	  Enable the allowlist feature for KernelSU to control root access.

          config KSU_SUKISU
          	bool "KernelSU Sukisu"
          	default y
          	help
          	  Enable Sukisu support within KernelSU.

          config KSU_DEBUG
          	bool "KernelSU Debugging"
          	default y
          	help
          	  Enable debugging features and messages for KernelSU.

          config KPM
          	bool "Kernel Patch Module (KPM)"
          	default y
          	help
          	  Enable the Kernel Patch Module, a dependency for KernelSU.

          config KSU_SUPERCALLS
          	bool "KernelSU Supercalls"
          	default y
          	help
          	  Enable KernelSU supercalls for advanced functionality.

          config KSU_ENFORCE
          	bool "KernelSU Enforce"
          	default y
          	help
          	  Enable enforcing mode for KernelSU security policies.

          config KSU_PERMISSIVE
          	bool "KernelSU Permissive"
          	default y
          	help
          	  Enable permissive mode for KernelSU, useful for debugging.

          config KSU_CORE_INIT
          	bool "KernelSU Core Init"
          	default y
          	help
          	  Enable core initialization logic for KernelSU.

          config KSU_KSUD_INIT
          	bool "KernelSU KSUD Init"
          	default y
          	help
          	  Enable initialization of the KSUD daemon.

          config KSU_ALLOWLIST_INIT
          	bool "KernelSU Allowlist Init"
          	default y
          	help
          	  Enable initialization of the KernelSU allowlist.

          config KSU_GET_ROOT_PROFILE
          	bool "KernelSU Get Root Profile"
          	default y
          	help
          	  Enable functionality to get the root profile.

          config KSU_MANUAL_HOOK
          	bool "KernelSU Manual Hook"
          	default y
          	help
          	  Enable manual hooking capabilities for KernelSU.

          # SUSFS Configurations
          config KSU_SUSFS
          	bool "SUSFS Support"
          	default y
          	help
          	  Enable SUSFS, a filesystem for hiding kernel modifications.

          if KSU_SUSFS

          config KSU_SUSFS_HAS_MAGIC_MOUNT
          	bool "SUSFS Magic Mount"
          	default y
          	help
          	  Enable magic mount feature in SUSFS.

          config KSU_SUSFS_SUS_PATH
          	bool "SUSFS Path"
          	default y
          	help
          	  Configure the SUSFS path.

          config KSU_SUSFS_SUS_MOUNT
          	bool "SUSFS Mount"
          	default y
          	help
          	  Configure the SUSFS mount point.

          config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          	bool "SUSFS Auto Add KSU Default Mount"
          	default y
          	help
          	  Automatically add the default KSU mount to SUSFS.

          config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          	bool "SUSFS Auto Add Bind Mount"
          	default y
          	help
          	  Automatically add bind mounts to SUSFS.

          config KSU_SUSFS_SUS_KSTAT
          	bool "SUSFS Kstat"
          	default y
          	help
          	  Enable kstat support within SUSFS.

          config KSU_SUSFS_TRY_UMOUNT
          	bool "SUSFS Try Unmount"
          	default y
          	help
          	  Enable attempting to unmount in SUSFS.

          config KSU_SUSFS_SPOOF_UNAME
          	bool "SUSFS Spoof Uname"
          	default y
          	help
          	  Enable uname spoofing in SUSFS.

          config KSU_SUSFS_ENABLE_LOG
          	bool "SUSFS Enable Logging"
          	default y
          	help
          	  Enable logging for SUSFS.

          config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          	bool "SUSFS Hide Symbols"
          	default y
          	help
          	  Hide KernelSU and SUSFS symbols.

          config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          	bool "SUSFS Spoof Cmdline/Bootconfig"
          	default y
          	help
          	  Spoof kernel command line or bootconfig via SUSFS.

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "SUSFS Open Redirect"
          	default y
          	help
          	  Enable open redirect functionality in SUSFS.

          endif # KSU_SUSFS

          endif # KSU

          endmenu
          # --- End KernelSU/SUSFS Configuration ---' >> "$KCONFIG_FILE"

      - name: Configure Custom KernelSU Kconfig
        working-directory: kernel
        run: |
          echo "[+] Configuring custom KernelSU Kconfig"
          KCONFIG_FILE=$GITHUB_WORKSPACE/kernel/drivers/kernelsu/Kconfig

          cat > "$KCONFIG_FILE" << 'EOF'
          menu "KernelSU"

          config KSU
                tristate "KernelSU function support"
                default y
                help
                  Enable kernel-level root privileges on Android System.

          config KSU_DEBUG
                bool "KernelSU debug mode"
                depends on KSU
                default y
                help
                  Enable KernelSU debug mode.

          config KSU_MULTI_MANAGER_SUPPORT
              bool "Multi KernelSU manager support"
              depends on KSU
              default y
              help
                  Enable multi KernelSU manager support

          config KSU_ALLOWLIST_WORKAROUND
              bool "KernelSU Session Keyring Init workaround"
              depends on KSU
              default n
              help
                Enable session keyring init workaround for problematic devices.

          config KPM
                bool "Enable SukiSU KPM"
                depends on KSU && 64BIT
                select KALLSYMS
                select KALLSYMS_ALL
                default y
                help
                  Enabling this option will activate the KPM feature of SukiSU.

          config KSU_MANUAL_HOOK
              bool "Hook KernelSU manually"
              depends on KSU != m
              help
                If enabled, Hook required KernelSU syscalls with manually-patched function.

          menu "KernelSU - SUSFS"

          config KSU_SUSFS
          	bool "KernelSU addon - SUSFS"
          	depends on KSU
          	depends on THREAD_INFO_IN_TASK
          	default y
          	help
          		Patch and Enable SUSFS to kernel with KernelSU.

          config KSU_SUSFS_SUS_PATH
          	bool "Enable to hide suspicious path (NOT recommended)"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding user-defined paths and sub-paths from system calls.

          config KSU_SUSFS_SUS_MOUNT
          	bool "Enable to hide suspicious mounts"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding user-defined mount paths from /proc/self/[mounts|mountinfo|mountstat].

          config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          	bool "Enable to hide KSU's default mounts automatically (experimental)"
          	depends on KSU_SUSFS_SUS_MOUNT
          	default y
          	help
          		Automatically add KSU's default mounts to sus_mount.

          config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          	bool "Enable to hide suspicious bind mounts automatically (experimental)"
          	depends on KSU_SUSFS_SUS_MOUNT
          	default y
          	help
          		Automatically add binded mounts to sus_mount.

          config KSU_SUSFS_SUS_KSTAT
          	bool "Enable to spoof suspicious kstat"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow spoofing the kstat of user-defined file/directory.

          config KSU_SUSFS_TRY_UMOUNT
          	bool "Enable to use ksu's try_umount"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow using try_umount to umount other user-defined mount paths.

          config KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          	bool "Enable to add bind mounts to ksu's try_umount automatically (experimental)"
          	depends on KSU_SUSFS_TRY_UMOUNT
          	default y
          	help
          		Automatically add binded mounts to ksu's try_umount.

          config KSU_SUSFS_SPOOF_UNAME
          	bool "Enable to spoof uname"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow spoofing the string returned by uname syscall.

          config KSU_SUSFS_ENABLE_LOG
          	bool "Enable logging susfs log to kernel"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow logging susfs log to kernel.

          config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          	bool "Enable to automatically hide ksu and susfs symbols from /proc/kallsyms"
          	depends on KSU_SUSFS
          	default y
          	help
          		Automatically hide ksu and susfs symbols from '/proc/kallsyms'.

          config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          	bool "Enable to spoof /proc/cmdline or /proc/bootconfig"
          	depends on KSU_SUSFS
          	default y
          	help
          		Spoof the output of /proc/cmdline or /proc/bootconfig with user-defined file.

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "Enable to redirect a path to be opened with another path (experimental)"
          	depends on KSU_SUSFS
          	default n
          	help
          		Allow redirecting a target path to be opened with another user-defined path.

          config KSU_SUSFS_SUS_MAP
          	bool "Enable to hide some mmapped real file from proc maps interfaces"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding mmapped real file from /proc/<pid>/[maps|smaps|smaps_rollup|map_files|mem|pagemap]

          endmenu

          endmenu
          EOF

      - name: Add Kernel Configuration Options  - x86_64_arcvm_defconfig
        working-directory: kernel
        run: |
          echo "[+] Adding comprehensive kernel configuration options for x86_64"
          CONFIG_FILE="arch/x86/configs/x86_64_arcvm_defconfig"

          echo "CONFIG_KSU=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_DEBUG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> $CONFIG_FILE

          if [ "${{ inputs.use_kpm }}" == "true" ]; then
            echo "CONFIG_KPM=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS_ALL=y" >> $CONFIG_FILE
          fi

          echo "CONFIG_KSU_SUSFS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $CONFIG_FILE

          echo "CONFIG_TMPFS_XATTR=y" >> $CONFIG_FILE
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONFIG_FILE

          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $CONFIG_FILE

          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $CONFIG_FILE
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONFIG_FILE
          echo "CONFIG_NET_SCH_FQ=y" >> $CONFIG_FILE

          if [ "${{ inputs.use_zram }}" == "true" ]; then
            echo "CONFIG_ZSMALLOC=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZO=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4HC=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4KD=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_842=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_WRITEBACK=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $CONFIG_FILE
          fi

      - name: Add Kernel Configuration Options  - arm64_arcvm_defconfig
        working-directory: kernel
        run: |
          echo "[+] Adding comprehensive kernel configuration options for arm64"
          CONFIG_FILE="arch/arm64/configs/arm64_arcvm_defconfig"

          echo "CONFIG_KSU=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_DEBUG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> $CONFIG_FILE

          if [ "${{ inputs.use_kpm }}" == "true" ]; then
            echo "CONFIG_KPM=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS_ALL=y" >> $CONFIG_FILE
          fi

          echo "CONFIG_KSU_SUSFS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $CONFIG_FILE

          echo "CONFIG_TMPFS_XATTR=y" >> $CONFIG_FILE
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONFIG_FILE

          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $CONFIG_FILE

          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $CONFIG_FILE
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONFIG_FILE
          echo "CONFIG_NET_SCH_FQ=y" >> $CONFIG_FILE

          if [ "${{ inputs.use_zram }}" == "true" ]; then
            echo "CONFIG_ZSMALLOC=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZO=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4HC=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4KD=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_842=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_WRITEBACK=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $CONFIG_FILE
          fi

      - name: Configure Build Flags for KPM
        working-directory: kernel
        run: |
            echo "⚙️ Enforcing KCFLAGS=-Wno-error globally..."
            echo 'KCFLAGS += -Wno-error' >> scripts/Makefile.extrawarn || true

            echo "✅ Build flags configured."

      - name: Configure Kernel Version
        working-directory: kernel
        run: |
          echo "Using custom version suffix: ${{ inputs.custom_version }}"
          sed -i "s/^EXTRAVERSION.*/EXTRAVERSION = -${{ inputs.custom_version }}/" Makefile
          sed -i 's/-dirty//' scripts/setlocalversion

      - name: Build Kernel
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          set -a && . ${{ matrix.build_config }}; set +a
          export DEFCONFIG=${{ matrix.defconfig }}
          if [ ! -z ${{ vars.EXPECTED_SIZE }} ] && [ ! -z ${{ vars.EXPECTED_HASH }} ]; then
            export KSU_EXPECTED_SIZE=${{ vars.EXPECTED_SIZE }}
            export KSU_EXPECTED_HASH=${{ vars.EXPECTED_HASH }}
          fi

          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) ${KERNEL_IMAGE_NAME} modules prepare-objtool
          ls -l -h ${PWD}/arch/${ARCH}/boot
          echo "file_path=${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV

      - name: Upload kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}
        uses: actions/upload-artifact@v5
        with:
          name: kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}
          path: "${{ env.file_path }}"
